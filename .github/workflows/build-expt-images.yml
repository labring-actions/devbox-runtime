name: Build Expt Images
on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag for the Docker image'
        required: true
        default: 'latest'
      l10n:
        description: 'Localization setting (e.g., en_US, zh_CN)'
        required: false
        type: choice
        options:
          - en_US
          - zh_CN
        default: 'en_US'
      arch:
        description: 'System architecture (e.g., amd64, arm64)'
        required: false
        type: choice
        options:
          - amd64
          - arm64
        default: 'amd64'
      aliyun_enabled:
        description: 'Enable Aliyun ACR builds'
        required: false
        type: boolean
        default: false
      kind:
        description: 'Type of packages to build'
        required: false
        type: choice
        options:
          - operating-systems
          - languages
        default: 'operating-systems'
      name:
        required: false
        description: 'Name of the specific package to build'
        type: string
        default: ''

jobs:
  # Define expt image matrix
  define-matrix:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.set_tag.outputs.tag }}
      tag_l10n: ${{ steps.set_tag.outputs.tag_l10n }}
      l10n_normalized: ${{ steps.set_tag.outputs.l10n_normalized }}
      packages: ${{ steps.get_packages.outputs.packages }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up tag
        id: set_tag
        run: |
          if [ -n "${{ inputs.tag }}" ]; then
            tag=${{ inputs.tag }}
          else
            tag=$(echo "${{ github.sha }}" | cut -c1-7)
          fi
          # Convert l10n to lowercase with hyphens (e.g., en_US -> en-us)
          l10n_normalized=$(echo "${{ inputs.l10n }}" | tr '[:upper:]' '[:lower:]' | tr '_' '-')
          tag_l10n=$tag-$l10n_normalized
          echo "tag=$tag" >> $GITHUB_OUTPUT
          echo "tag_l10n=$tag_l10n" >> $GITHUB_OUTPUT
          echo "l10n_normalized=$l10n_normalized" >> $GITHUB_OUTPUT

      - name: Get packages
        id: get_packages
        run: |
          # Get all packages
          kind=${{ inputs.kind }}
          name=${{ inputs.name }}
          if [ -n "$name" ]; then
            echo "Looking for specific package: $name"
            target_dockerfiles=$(find experimental/images/$kind -name "Dockerfile" -path "*/$name/Dockerfile")
            if [ -z "$target_dockerfiles" ]; then
              echo "Error: No Dockerfile found for package '$name' in kind '$kind'" >&2
              exit 1
            fi
          else
            echo "No specific package provided, gathering all packages of kind: $kind"
            target_dockerfiles=$(find experimental/runtimes/$kind -name "Dockerfile")
          fi

          # Convert to JSON array
          packages=$(echo "$target_dockerfiles" | jq -R -s 'split("\n")[:-1]')

          echo "packages<<EOF" >> $GITHUB_OUTPUT
          echo "$packages" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          package_count=$(echo "$packages" | jq 'length // 0')
          echo "Found $package_count packages to build"

  # Build expt images
  build-expt-images:
    runs-on: ubuntu-latest
    needs: define-matrix
    strategy:
      fail-fast: false
      matrix:
        packages: ${{ fromJson(needs.define-matrix.outputs.packages) }}
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Generate image names (standard)
        id: generate-standard
        uses: ./.github/actions/generate-image-names
        with:
          dockerfile: ${{ matrix.packages }}
          tag: ${{ needs.define-matrix.outputs.tag_l10n }}
          ghcr_credentials: ${{ format('{{"registry":"{0}","username":"{1}","password":"{2}"}}', 'ghcr.io', github.repository_owner, secrets.GITHUB_TOKEN) || '{}' }}
          aliyun_credentials: ${{ inputs.aliyun_enabled == 'true' && format('{{"registry":"{0}","username":"{1}","password":"{2}", "namespace":"{3}"}}', secrets.ALIYUN_REGISTRY, secrets.ALIYUN_USERNAME, secrets.ALIYUN_PASSWORD, secrets.ALIYUN_NAMESPACE) || '{}' }}
          expt_base_image_naming: 'true'
      - name: Build and push standard images
        uses: ./.github/actions/build-and-push
        with:
          build_args: |
            REPO=${{ github.repository_owner }}/devbox-base-expt
            L10N=${{ inputs.l10n }}
            L10N_NORMALIZED=${{ needs.define-matrix.outputs.l10n_normalized }}
            ARCH=${{ inputs.arch }} 
          dockerfile: ${{ matrix.packages }}
          ghcr_credentials: ${{ format('{{"registry":"{0}","username":"{1}","password":"{2}"}}', 'ghcr.io', github.repository_owner, secrets.GITHUB_TOKEN) || '{}' }}
          ghcr_image_name: ${{ steps.generate-standard.outputs.ghcr_image_name }}
          aliyun_credentials: ${{ inputs.aliyun_enabled == 'true' && format('{{"registry":"{0}","username":"{1}","password":"{2}", "namespace":"{3}"}}', secrets.ALIYUN_REGISTRY, secrets.ALIYUN_USERNAME, secrets.ALIYUN_PASSWORD, secrets.ALIYUN_NAMESPACE) || '{}' }}
          acr_image_name: ${{ steps.generate-standard.outputs.acr_image_name }}
      - name: Clean up images (standard)
        if: always()
        run: |
          set -eux
          # Remove GHCR image by tag if present
          if [ -n "${{ steps.generate-standard.outputs.ghcr_image_name }}" ]; then
            echo "Removing local image: ${{ steps.generate-standard.outputs.ghcr_image_name }} (if exists)"
            docker image rm -f "${{ steps.generate-standard.outputs.ghcr_image_name }}" || true
          fi
          # Remove Aliyun/ACR image by tag if present
          if [ -n "${{ steps.generate-standard.outputs.acr_image_name }}" ]; then
            echo "Removing local image: ${{ steps.generate-standard.outputs.acr_image_name }} (if exists)"
            docker image rm -f "${{ steps.generate-standard.outputs.acr_image_name }}" || true
          fi
          # Remove dangling images and builder cache to free space
          docker image prune -af || true
          # If docker buildx was used, prune builder cache as well
          docker builder prune -af || true
      - name: Output built image names (standard)
        run: |
          echo "## ðŸ³ Built OS Base Images (Standard)" >> $GITHUB_STEP_SUMMARY
          echo "| Image Name | Registry |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| ${{ steps.generate-standard.outputs.ghcr_image_name }} | GHCR |" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.generate-standard.outputs.acr_image_name }}" != "" ]; then
            echo "| ${{ steps.generate-standard.outputs.acr_image_name }} | Aliyun ACR |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ Pull Command" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ steps.generate-standard.outputs.ghcr_image_name }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
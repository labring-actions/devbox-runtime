name: Build Docker Images (Three Levels)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag for the Docker image'
        required: true
        default: 'latest'
      build_all:
        description: 'Build all images (ignore changes)'
        required: false
        default: 'true'
      aliyun_enabled:
        description: 'Enable Aliyun ACR builds'
        required: false
        default: 'false'
  push:
    branches:
      - 'main'

jobs:
  # Define build matrix using bin/runtimectl ci build-order
  define-matrix:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.set_tag.outputs.tag }}
      tag_cn: ${{ steps.set_tag.outputs.tag_cn }}
      build_order: ${{ steps.get_build_order.outputs.build_order }}
      level_0: ${{ steps.get_levels.outputs.level_0 }}
      level_1: ${{ steps.get_levels.outputs.level_1 }}
      level_2: ${{ steps.get_levels.outputs.level_2 }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup bin/runtimectl
        uses: ./.github/actions/setup-runtimectl

      - name: Set up tag
        id: set_tag
        run: |
          if [ -n "${{ inputs.tag }}" ]; then
            tag=${{ inputs.tag }}
          else
            tag=$(echo "${{ github.sha }}" | cut -c1-7)
          fi
          tag_cn=$tag-cn
          echo "tag=$tag" >> $GITHUB_OUTPUT
          echo "tag_cn=$tag_cn" >> $GITHUB_OUTPUT

      - name: Get build order
        id: get_build_order
        run: |
          if [ "${{ inputs.build_all }}" = "true" ] || [ -n "${{ inputs.tag }}" ]; then
            # Get all images in dependency order
            build_order=$(./bin/runtimectl -o json ci build-order | jq -c .)
          else
            # Get changed images with dependencies
            changed_files=$(./bin/runtimectl ci build-matrix --changed --commit1 $(echo "${{ github.event.before }}" | cut -c1-7) --commit2 $(echo "${{ github.sha }}" | cut -c1-7) --with-dependencies)
            build_order=$(./bin/runtimectl -o json ci build-order | jq --argjson changed "$changed_files" '[.[] | select(. as $item | $changed | index($item))]' | jq -c .)
          fi
          echo "build_order<<EOF" >> $GITHUB_OUTPUT
          echo "$build_order" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Get dependency levels
        id: get_levels
        run: |
          # Get dependency graph and extract levels
          graph=$(./bin/runtimectl -o json ci analyze-dependencies)
          level_0=$(echo "$graph" | jq -c '.levels[0] // []')
          level_1=$(echo "$graph" | jq -c '.levels[1] // []')
          level_2=$(echo "$graph" | jq -c '.levels[2] // []')

          echo "level_0<<EOF" >> $GITHUB_OUTPUT
          echo "$level_0" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "level_1<<EOF" >> $GITHUB_OUTPUT
          echo "$level_1" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "level_2<<EOF" >> $GITHUB_OUTPUT
          echo "$level_2" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Output level information
          echo "Level 0 (OS): $(echo "$level_0" | jq 'length') packages"
          echo "Level 1 (Language): $(echo "$level_1" | jq 'length') packages"
          echo "Level 2 (Framework): $(echo "$level_2" | jq 'length') packages"

      - name: Validate dependencies
        run: |
          ./bin/runtimectl ci validate-dependencies

  # Build Level 0: Base Images (OS)
  build-level-0:
    runs-on: ubuntu-latest
    needs: define-matrix
    if: ${{ fromJson(needs.define-matrix.outputs.level_0) != null && length(fromJson(needs.define-matrix.outputs.level_0)) > 0 }}
    permissions:
      contents: read
      packages: write
    steps:
      - name: Build Level 0
        uses: ./.github/actions/build-level
        with:
          level_index: 0
          level_packages: ${{ needs.define-matrix.outputs.level_0 }}
          tag: ${{ needs.define-matrix.outputs.tag }}
          tag_cn: ${{ needs.define-matrix.outputs.tag_cn }}
          aliyun_enabled: ${{ inputs.aliyun_enabled }}

  # Build Level 1: Language Images (depends on Level 0)
  build-level-1:
    runs-on: ubuntu-latest
    needs: [define-matrix, build-level-0]
    if: ${{ fromJson(needs.define-matrix.outputs.level_1) != null && length(fromJson(needs.define-matrix.outputs.level_1)) > 0 }}
    permissions:
      contents: read
      packages: write
    steps:
      - name: Build Level 1
        uses: ./.github/actions/build-level
        with:
          level_index: 1
          level_packages: ${{ needs.define-matrix.outputs.level_1 }}
          tag: ${{ needs.define-matrix.outputs.tag }}
          tag_cn: ${{ needs.define-matrix.outputs.tag_cn }}
          aliyun_enabled: ${{ inputs.aliyun_enabled }}

  # Build Level 2: Framework Images (depends on Level 1)
  build-level-2:
    runs-on: ubuntu-latest
    needs: [define-matrix, build-level-1]
    if: ${{ fromJson(needs.define-matrix.outputs.level_2) != null && length(fromJson(needs.define-matrix.outputs.level_2)) > 0 }}
    permissions:
      contents: read
      packages: write
    steps:
      - name: Build Level 2
        uses: ./.github/actions/build-level
        with:
          level_index: 2
          level_packages: ${{ needs.define-matrix.outputs.level_2 }}
          tag: ${{ needs.define-matrix.outputs.tag }}
          tag_cn: ${{ needs.define-matrix.outputs.tag_cn }}
          aliyun_enabled: ${{ inputs.aliyun_enabled }}

  # Generate runtime configuration
  generate-config:
    runs-on: ubuntu-latest
    needs: [define-matrix, build-level-0, build-level-1, build-level-2]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup bin/runtimectl
        uses: ./.github/actions/setup-runtimectl

      - name: Generate runtime configuration
        run: |
          echo "Generating runtime configuration..."
          ./bin/runtimectl ci generate-config --tag "${{ needs.define-matrix.outputs.tag }}"
          ./bin/runtimectl ci generate-config --cn --tag "${{ needs.define-matrix.outputs.tag_cn }}"

  # Generate dependency graph visualization
  generate-dependency-graph:
    runs-on: ubuntu-latest
    needs: [define-matrix]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup bin/runtimectl
        uses: ./.github/actions/setup-runtimectl

      - name: Generate dependency graph
        run: |
          echo "## Dependency Graph" >> $GITHUB_STEP_SUMMARY
          ./bin/runtimectl ci dependency-graph >> $GITHUB_STEP_SUMMARY

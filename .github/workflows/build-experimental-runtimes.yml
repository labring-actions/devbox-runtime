name: Build Experimental Runtimes

on:
  pull_request:
    paths:
      - 'experimental/runtimes/**'
      - '.github/workflows/**'
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Custom image tag (defaults to short commit SHA)'
        required: false
      architectures:
        description: 'Comma-separated architectures (default: amd64,arm64)'
        required: false
      cn_patch_enabled:
        description: 'Enable CN patch modifications'
        required: false
        default: 'false'

permissions:
  contents: read
  packages: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v2

      - name: Compute parameters
        id: params
        run: |
          set -euo pipefail
          ARCHS="${{ inputs.architectures }}"
          if [ -z "$ARCHS" ]; then ARCHS="amd64,arm64"; fi
          ARCHS="$(echo "$ARCHS" | tr -d ' ')"
          ALLOWED="amd64 arm64 armv7"
          IFS=',' read -r -a REQ_ARCHS <<< "$ARCHS"
          PLATFORM_LIST=""
          for a in "${REQ_ARCHS[@]}"; do
            if [[ ! " $ALLOWED " =~ " $a " ]]; then
              echo "ERROR: Unsupported architecture '$a'. Allowed: $ALLOWED" >&2
              exit 1
            fi
            [ -n "$PLATFORM_LIST" ] && PLATFORM_LIST+="," || true
            PLATFORM_LIST+="linux/$a"
          done
          echo "platforms=$PLATFORM_LIST" >> $GITHUB_OUTPUT
          TAG_INPUT="${{ inputs.image_tag }}"
          if [ -z "$TAG_INPUT" ]; then TAG_INPUT="${GITHUB_SHA:0:8}"; fi
          echo "image_tag=$TAG_INPUT" >> $GITHUB_OUTPUT
          if [[ "$TAG_INPUT" =~ ^v?[0-9]+\.[0-9]+\.[0-9]+([.-][A-Za-z0-9._-]+)?$ ]]; then
            echo "add_latest=true" >> $GITHUB_OUTPUT
          else
            echo "add_latest=false" >> $GITHUB_OUTPUT
          fi

      - name: Log in to GHCR (pushes only)
        if: ${{ github.event_name == 'workflow_dispatch' }}
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Discover runtime Dockerfiles
        id: find
        run: |
          find experimental/runtimes -type f -name Dockerfile -not -path "*/base-tools/*" -not -path "*/configure-tools/*" || true

      - name: Build discovered runtime Dockerfiles
        env:
          IMAGE_TAG: ${{ steps.params.outputs.image_tag }}
          PLATFORMS: ${{ steps.params.outputs.platforms }}
          ADD_LATEST: ${{ steps.params.outputs.add_latest }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: devbox-expt-runtime
          PR_NUMBER: ${{ github.event.pull_request.number || '' }}
        run: |
          chmod +x .github/scripts/build-experimental-runtimes.sh
          .github/scripts/build-experimental-runtimes.sh
        shell: bash
